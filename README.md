# Arduino FFT Basic - M5Stack Sound Analysis System

ESP32/M5Stack用のリアルタイム音響解析システムです。PDMマイクを使用してFFT解析とオクターブバンド分析を行い、CSV形式でのデータロギング機能を提供します。

## 主な機能

### 🎵 リアルタイムFFTスペクトラム表示（Aボタン）
- 30kHzサンプリングレートでの音声取得
- 1024ポイントFFT解析（arduinoFFTライブラリ使用）
- 0-8kHzの周波数範囲をリアルタイム表示
- Hanning窓関数による高精度解析

### 📊 1/1オクターブバンド分析（Bボタン）
- ISO 266準拠の標準オクターブバンド（125Hz-4kHz、6バンド）
- 1秒間Leq（等価騒音レベル）の自動計算
- 周波数帯域別補正値適用（各マイクキャリブレーション対応）
- A特性補正によるLAeq合算値表示
- カラーバーグラフによる視覚的表示（20-120dB）
- CSVファイルへの自動記録機能

### ⏰ 時刻設定機能（Cボタン）
- NTP同期対応の時刻設定
- CSV記録時のタイムスタンプ生成
- 直感的なUI操作

## ハードウェア要件

- **M5Stack Core ESP32**
- **PDMマイクロフォンユニット**（PORT-A接続）
- **microSDカード**（CSV記録用）

### 接続仕様
- CLKピン: GPIO22
- DATAピン: GPIO21
- サンプリング周波数: 30kHz
- 分解能: 16bit

## ソフトウェア構成

### 📁 ファイル構造

```
src/
├── main.cpp                    # メインループ・統合制御
├── common/                     # 共通機能
│   ├── common.h               # 定数・構造体・プロトタイプ宣言
│   └── common.cpp             # 共通関数実装
├── modules/                    # 機能別モジュール
│   ├── fft_display.h/.cpp     # Aボタン: FFTスペクトラム表示
│   ├── octave_band.h/.cpp     # Bボタン: オクターブバンド分析
│   └── time_setting.h/.cpp    # Cボタン: 時刻設定
└── audio/                      # 音声処理
    ├── audio_processing.h     # FFT処理・マイク制御
    └── audio_processing.cpp
```

### 🔧 各モジュールの詳細

#### `main.cpp`
- ボタン入力処理
- 表示モード切り替え
- 初期化・メインループ

#### `common/`
**共通定数・構造体**
- サンプリング設定（30kHz、1024FFT）
- マイク仕様（-22dBFS感度、94dB SPL基準）
- オクターブバンド中心周波数（125Hz-4kHz）
- 周波数帯域別補正値（マイクキャリブレーション）
- A特性補正値（125Hz:-16.1dB ～ 4000Hz:1.0dB）

**共通関数**
- I2S初期化
- dB SPL計算
- CSV入出力
- 画面ヘッダー表示

#### `modules/fft_display`
- FFT結果の24バンド表示
- 周波数軸目盛り生成
- カラーグラフィック描画

#### `modules/octave_band`
- 1/1オクターブバンドフィルタ実装（125Hz-4kHz、6バンド）
- Leq計算（1秒移動平均）
- 周波数帯域別補正値適用
- A特性補正によるLAeq合算計算
- バーグラフ表示・更新（20-120dB範囲）
- ピーク周波数検出

#### `modules/time_setting`
- 年月日時分秒の個別設定
- 長押し/短押し操作対応
- NTP時刻同期

#### `audio/audio_processing`
- I2Sマイク制御タスク
- arduinoFFT処理パイプライン
- マルチタスク音声処理

## 📋 操作方法

### ボタン操作
| ボタン | 機能 | 説明 |
|--------|------|------|
| **A** | FFT表示 | リアルタイムスペクトラム表示モード |
| **B** | オクターブバンド | 1/1オクターブバンド分析・CSV記録ON |
| **C** | 設定 | 時刻設定（他画面）/ CSV記録OFF（B画面） |

### CSV記録
- ファイル名: `/logger.csv`
- 記録間隔: 1秒
- フォーマット: `日付,時刻,125Hz,250Hz,500Hz,1000Hz,2000Hz,4000Hz,LAeq`
- 補正値適用済みデータを記録

## 🛠️ ビルド環境

### 依存ライブラリ
```ini
lib_deps = 
    m5stack/M5Stack@^0.4.6
    kosme/arduinoFFT@^2.0.2
```

### ビルド設定
- Platform: ESP32
- Board: M5Stack Core ESP32
- Framework: Arduino
- Build flags: `-std=gnu++11`

## 📈 技術仕様

### FFT解析
- **窓関数**: Hanning窓（arduinoFFT実装）
- **サイズ**: 1024ポイント
- **周波数分解能**: 29.297Hz
- **表示範囲**: 0-8kHz（ナイキスト周波数の半分）

### オクターブバンド分析
- **規格**: ISO 266準拠
- **バンド数**: 6バンド（125-4000Hz）
- **フィルタ**: fc/√2 ～ fc×√2
- **Leq算出**: 1秒間移動平均（29サンプル）
- **補正**: 周波数帯域別補正値適用（マイクキャリブレーション）
- **A特性**: A特性補正によるLAeq合算値表示
- **表示範囲**: 20-120dB SPL

### 騒音レベル計算
```
基本dB計算: dB SPL = 20×log₁₀(amplitude/32768) - (-22) + 94
補正適用: 補正後dB = 基本dB + 周波数帯域別補正値
LAeq計算: LAeq = 10×log₁₀(Σ(10^((補正後dB + A特性補正)/10)))
```

## 🔄 開発履歴

### v2.1 - オクターブバンド機能強化
- オクターブバンドを125Hz-4kHzの6バンドに変更
- 縦軸表示範囲を20-120dBに拡張
- 周波数帯域別補正値機能を追加（マイクキャリブレーション対応）
- A特性補正によるLAeq合算値表示・記録機能を追加
- CSVフォーマット拡張（LAeq列追加）

### v2.0 - モジュール化リファクタリング
- 機能別ファイル分割（995行→170行）
- arduinoFFTライブラリ移行
- 保守性・拡張性の大幅向上

### v1.0 - 初期実装
- 自前FFT実装
- 基本的な音響解析機能

## 📝 ライセンス

このプロジェクトはオープンソースです。商用・非商用問わずご利用いただけます。

## 🤝 コントリビューション

機能改善・バグ修正のプルリクエストを歓迎します。

---

**開発環境**: PlatformIO + Arduino Framework  
**対象デバイス**: M5Stack Core ESP32  
**最終更新**: 2025年7月29日